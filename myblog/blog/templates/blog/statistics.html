{% extends 'blog/base.html' %}

{% block title %}统计面板 - 我的博客{% endblock %}

{% block extra_css %}
<style>
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: #f8f9fa;
        background-image: url('/static/images/1748243954412.png');
        background-size: 100% auto;  /* 关键修改 */
        background-position: center;
        background-repeat: no-repeat;
        background-attachment: fixed;
        min-height: 100vh;
        margin: 0;
        padding: 0;
    }
    .stat-card {
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.5);
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    }
    
    .stat-icon {
        font-size: 2.5rem;
        opacity: 0.8;
    }
    
    .stat-value {
        font-size: 2rem;
        font-weight: bold;
        margin: 10px 0;
    }
    
    .stat-label {
        color: #6c757d;
        font-size: 0.9rem;
        background-color: rgba(255, 255, 255, 0.5);
    }
    
    .chart-container {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.5);
    }
    
    .chart-title {
        border-bottom: 2px solid #f8f9fa;
        padding-bottom: 10px;
        margin-bottom: 20px;
        color: #343a40;
    }
    
    .table-hover tbody tr:hover {
        background-color: rgba(0, 123, 255, 0.05);
    }
    
    .badge-stat {
        font-size: 0.8rem;
        padding: 5px 10px;
    }
    
    .time-range {
        cursor: pointer;
        transition: all 0.3s;
        background-color: rgba(255, 255, 255, 0.5);
    }
    
    .time-range.active {
        background-color: #0d6efd;
        color: white;
        border-color: #0d6efd;
    }
    
    .progress {
        height: 10px;
        border-radius: 5px;
    }
    
    .trend-up {
        color: #28a745;
    }
    
    .trend-down {
        color: #dc3545;
    }
    
    .trend-neutral {
        color: #6c757d;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 页面标题 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">
            <i class="fas fa-chart-bar text-primary"></i> 统计面板
        </h1>
        <div>
            <span class="badge bg-info">
                <i class="fas fa-clock"></i> {% now "Y年m月d日 H:i" %}
            </span>
        </div>
    </div>

    <!-- 时间范围选择器 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card" style="background-color: rgba(255, 255, 255, 0.5);">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-calendar-alt"></i> 时间范围
                    </h5>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-primary time-range active" data-range="today">
                            今天
                        </button>
                        <button type="button" class="btn btn-outline-primary time-range" data-range="week">
                            最近7天
                        </button>
                        <button type="button" class="btn btn-outline-primary time-range" data-range="month">
                            最近30天
                        </button>
                        <button type="button" class="btn btn-outline-primary time-range" data-range="all">
                            全部时间
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 概览统计卡片 -->
    <div class="row mb-4">
        <!-- 总访问量 -->
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="stat-card card border-primary">
                <div class="card-body text-center">
                    <div class="stat-icon text-primary">
                        <i class="fas fa-eye"></i>
                    </div>
                    <div class="stat-value text-primary" id="totalVisits">
                        {{ total_visits|default:0 }}
                    </div>
                    <div class="stat-label">总访问量</div>
                </div>
            </div>
        </div>
        
        <!-- 今日访问 -->
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="stat-card card border-success">
                <div class="card-body text-center">
                    <div class="stat-icon text-success">
                        <i class="fas fa-calendar-day"></i>
                    </div>
                    <div class="stat-value text-success" id="todayVisits">
                        {{ today_visits|default:0 }}
                    </div>
                    <div class="stat-label">今日访问</div>
                </div>
            </div>
        </div>
        
        <!-- 总文章数 -->
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="stat-card card border-info">
                <div class="card-body text-center">
                    <div class="stat-icon text-info">
                        <i class="fas fa-file-alt"></i>
                    </div>
                    <div class="stat-value text-info" id="totalPosts">
                        {{ total_posts|default:0 }}
                    </div>
                    <div class="stat-label">文章总数</div>
                </div>
            </div>
        </div>
        
        <!-- 已发布文章 -->
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="stat-card card border-warning">
                <div class="card-body text-center">
                    <div class="stat-icon text-warning">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-value text-warning" id="publishedPosts">
                        {{ published_posts|default:0 }}
                    </div>
                    <div class="stat-label">已发布文章</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 第二行统计卡片 -->
    <div class="row mb-4">
        <!-- 本周访问 -->
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="stat-card card border-danger">
                <div class="card-body text-center">
                    <div class="stat-icon text-danger">
                        <i class="fas fa-calendar-week"></i>
                    </div>
                    <div class="stat-value text-danger" id="weekVisits">
                        {{ week_visits|default:0 }}
                    </div>
                    <div class="stat-label">本周访问</div>
                </div>
            </div>
        </div>
        
        <!-- 本月访问 -->
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="stat-card card border-secondary">
                <div class="card-body text-center">
                    <div class="stat-icon text-secondary">
                        <i class="fas fa-calendar-month"></i>
                    </div>
                    <div class="stat-value text-secondary" id="monthVisits">
                        {{ month_visits|default:0 }}
                    </div>
                    <div class="stat-label">本月访问</div>
                </div>
            </div>
        </div>
        
        <!-- 草稿文章 -->
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="stat-card card border-warning">
                <div class="card-body text-center">
                    <div class="stat-icon text-warning">
                        <i class="fas fa-edit"></i>
                    </div>
                    <div class="stat-value text-warning" id="draftPosts">
                        {{ draft_posts|default:0 }}
                    </div>
                    <div class="stat-label">草稿文章</div>
                </div>
            </div>
        </div>
        
        <!-- 归档文章 -->
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="stat-card card border-secondary">
                <div class="card-body text-center">
                    <div class="stat-icon text-secondary">
                        <i class="fas fa-archive"></i>
                    </div>
                    <div class="stat-value text-secondary" id="archivedPosts">
                        {{ archived_posts|default:0 }}
                    </div>
                    <div class="stat-label">归档文章</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 图表区域 -->
    <div class="row mb-4">
        <!-- 访问趋势图 -->
        <div class="col-lg-8 mb-3">
            <div class="chart-container">
                <h4 class="chart-title">
                    <i class="fas fa-chart-line"></i> 访问趋势
                </h4>
                <div class="chart-wrapper" style="height: 300px;">
                    <canvas id="visitsChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- 浏览器分布 -->
        <div class="col-lg-4 mb-3">
            <div class="chart-container">
                <h4 class="chart-title">
                    <i class="fas fa-globe"></i> 浏览器分布
                </h4>
                <div class="chart-wrapper" style="height: 300px;">
                    <canvas id="browsersChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- 详细数据表格 -->
    <div class="row">
        <!-- 热门页面 -->
        <div class="col-md-6 mb-3">
            <div class="chart-container">
                <h4 class="chart-title">
                    <i class="fas fa-fire"></i> 热门页面
                </h4>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>页面</th>
                                <th class="text-end">访问量</th>
                                <th class="text-end">占比</th>
                            </tr>
                        </thead>
                        <tbody id="popularPages">
                            {% for page in popular_pages|slice:":10" %}
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="flex-shrink-0">
                                            <i class="fas fa-link text-muted"></i>
                                        </div>
                                        <div class="flex-grow-1 ms-2">
                                            <div class="fw-medium" style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">
                                                {{ page.path }}
                                            </div>
                                        </div>
                                    </div>
                                </td>
                                <td class="text-end">
                                    <span class="badge bg-primary badge-stat">
                                        {{ page.count }}
                                    </span>
                                </td>
                                <td class="text-end">
                                    <div class="d-flex align-items-center justify-content-end">
                                        <div class="me-2" style="width: 100px;">
                                            <div class="progress">
                                                <div class="progress-bar bg-primary" 
                                                     style="width: {% widthratio page.count total_visits 100 %}%">
                                                </div>
                                            </div>
                                        </div>
                                        <span class="text-muted">
                                            {% widthratio page.count total_visits 100 %}%
                                        </span>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="3" class="text-center text-muted py-4">
                                    <i class="fas fa-chart-bar fa-2x mb-2"></i>
                                    <p>暂无访问数据</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- 文章排行 -->
        <div class="col-md-6 mb-3">
            <div class="chart-container">
                <h4 class="chart-title">
                    <i class="fas fa-trophy"></i> 热门文章排行
                </h4>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>文章</th>
                                <th class="text-end">浏览量</th>
                                <th class="text-end">评论数</th>
                                <th class="text-end">状态</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for post in top_posts %}
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="flex-shrink-0">
                                            {% if post.cover_image %}
                                            <img src="{{ post.cover_image.url }}" 
                                                 alt="{{ post.title }}"
                                                 class="rounded"
                                                 style="width: 40px; height: 40px; object-fit: cover;">
                                            {% else %}
                                            <div class="rounded bg-light d-flex align-items-center justify-content-center"
                                                 style="width: 40px; height: 40px;">
                                                <i class="fas fa-file-alt text-muted"></i>
                                            </div>
                                            {% endif %}
                                        </div>
                                        <div class="flex-grow-1 ms-2">
                                            <div class="fw-medium" style="max-width: 200px;">
                                                <a href="{% url 'post_detail' post.pk %}" 
                                                   class="text-decoration-none">
                                                    {{ post.title|truncatechars:30 }}
                                                </a>
                                            </div>
                                            <small class="text-muted">
                                                作者: {{ post.author.username }}
                                            </small>
                                        </div>
                                    </div>
                                </td>
                                <td class="text-end">
                                    <span class="badge bg-info badge-stat">
                                        <i class="fas fa-eye"></i> {{ post.view_count }}
                                    </span>
                                </td>
                                <td class="text-end">
                                    <span class="badge bg-success badge-stat">
                                        <i class="fas fa-comment"></i> {{ post.comments.count }}
                                    </span>
                                </td>
                                <td class="text-end">
                                    {% if post.status == 'published' %}
                                    <span class="badge bg-success">已发布</span>
                                    {% elif post.status == 'draft' %}
                                    <span class="badge bg-warning">草稿</span>
                                    {% else %}
                                    <span class="badge bg-secondary">已归档</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="text-center text-muted py-4">
                                    <i class="fas fa-newspaper fa-2x mb-2"></i>
                                    <p>暂无文章数据</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- 系统信息 -->
    <div class="row mb-4">
        <div class="col-md-6 mb-3">
            <div class="chart-container">
                <h4 class="chart-title">
                    <i class="fas fa-info-circle"></i> 系统信息
                </h4>
                <div class="list-group list-group-flush">
                    <div class="list-group-item">
                        <small class="text-muted">统计开始时间</small>
                        <div class="fw-medium">{{ month_ago|date:"Y年m月d日" }} 至今</div>
                    </div>
                    <div class="list-group-item">
                        <small class="text-muted">数据更新时间</small>
                        <div class="fw-medium">{% now "Y年m月d日 H:i:s" %}</div>
                    </div>
                    <div class="list-group-item">
                        <small class="text-muted">统计项目</small>
                        <div class="fw-medium">访问量、页面热度、文章排行</div>
                    </div>
                    <div class="list-group-item">
                        <small class="text-muted">数据来源</small>
                        <div class="fw-medium">数据库实时统计</div>
                        <img src="\static\images\backgrounds\7482439544100.png" style="height: 200px;">
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 快速操作 -->
        <div class="col-md-6 mb-3">
            <div class="chart-container">
                <h4 class="chart-title">
                    <i class="fas fa-bolt"></i> 快速操作
                </h4>
                <div class="row g-2">
                    <div class="col-6">
                        <a href="{% url 'post_create' %}" class="btn btn-outline-primary w-100 mb-2">
                            <i class="fas fa-plus"></i> 写新文章
                        </a>
                    </div>
                    <div class="col-6">
                        <a href="{% url 'admin:index' %}" class="btn btn-outline-success w-100 mb-2">
                            <i class="fas fa-cog"></i> 管理后台
                        </a>
                    </div>
                    <div class="col-6">
                        <button class="btn btn-outline-info w-100 mb-2" onclick="loadChartData()">
                            <i class="fas fa-sync-alt"></i> 刷新数据
                        </button>
                    </div>
                    <div class="col-6">
                        <button class="btn btn-outline-secondary w-100 mb-2" onclick="exportStats()">
                            <i class="fas fa-download"></i> 导出数据
                        </button>
                    </div>
                </div>
                <div class="mt-3">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="autoRefresh" checked>
                        <label class="form-check-label" for="autoRefresh">
                            自动刷新数据（每5分钟）
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- 引入 Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// 全局变量
let visitsChart = null;
let browsersChart = null;
let currentRange = 'today';
let autoRefreshInterval = null;

// DOM加载完成后执行
document.addEventListener('DOMContentLoaded', function() {
    // 初始化时间范围选择器
    initTimeRangeSelector();
    
    // 加载图表数据
    loadChartData();
    
    // 设置自动刷新
    setupAutoRefresh();
    
    // 初始化自动刷新开关
    initAutoRefreshSwitch();
});

// 初始化时间范围选择器
function initTimeRangeSelector() {
    const timeRangeButtons = document.querySelectorAll('.time-range');
    
    timeRangeButtons.forEach(button => {
        button.addEventListener('click', function() {
            // 移除所有按钮的active类
            timeRangeButtons.forEach(btn => btn.classList.remove('active'));
            
            // 为当前按钮添加active类
            this.classList.add('active');
            
            // 更新当前时间范围
            currentRange = this.dataset.range;
            
            // 重新加载数据
            loadChartData();
        });
    });
}

// 初始化自动刷新开关
function initAutoRefreshSwitch() {
    const autoRefreshSwitch = document.getElementById('autoRefresh');
    
    if (autoRefreshSwitch) {
        autoRefreshSwitch.addEventListener('change', function() {
            if (this.checked) {
                setupAutoRefresh();
            } else {
                clearAutoRefresh();
            }
        });
    }
}

// 设置自动刷新
function setupAutoRefresh() {
    clearAutoRefresh(); // 先清除现有定时器
    autoRefreshInterval = setInterval(loadChartData, 5 * 60 * 1000); // 5分钟
}

// 清除自动刷新
function clearAutoRefresh() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
    }
}

// 加载图表数据
async function loadChartData() {
    try {
        const response = await fetch('/api/visit-stats/');
        const data = await response.json();
        
        // 更新访问趋势图
        updateVisitsChart(data);
        
        // 更新浏览器分布图
        updateBrowsersChart(data);
        
        // 更新热门页面
        updatePopularPages(data.popular_paths);
        
        // 更新统计数字
        updateStatsNumbers(data);
        
        // 显示成功通知
        showNotification('数据已更新', 'success', 2000);
        
    } catch (error) {
        console.error('加载统计数据失败:', error);
        showNotification('加载统计数据失败，请重试', 'danger');
    }
}

// 更新访问趋势图
function updateVisitsChart(data) {
    const ctx = document.getElementById('visitsChart');
    if (!ctx) return;
    
    const ctx2d = ctx.getContext('2d');
    
    // 销毁旧图表
    if (visitsChart) {
        visitsChart.destroy();
    }
    
    // 创建新图表
    visitsChart = new Chart(ctx2d, {
        type: 'line',
        data: {
            labels: data.dates || [],
            datasets: [{
                label: '访问量',
                data: data.counts || [],
                borderColor: '#0d6efd',
                backgroundColor: 'rgba(13, 110, 253, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: '#0d6efd',
                pointBorderColor: '#ffffff',
                pointBorderWidth: 2,
                pointRadius: 4,
                pointHoverRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    callbacks: {
                        label: function(context) {
                            return `访问量: ${context.parsed.y}`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        maxRotation: 45,
                        minRotation: 45
                    }
                },
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    },
                    ticks: {
                        precision: 0
                    }
                }
            }
        }
    });
}

// 更新浏览器分布图
function updateBrowsersChart(data) {
    const ctx = document.getElementById('browsersChart');
    if (!ctx) return;
    
    const ctx2d = ctx.getContext('2d');
    
    // 处理浏览器数据
    const browsers = data.browsers || {};
    const browserLabels = Object.keys(browsers);
    const browserData = Object.values(browsers);
    
    // 定义颜色
    const backgroundColors = [
        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
        '#9966FF', '#FF9F40', '#C9CBCF', '#FF6384'
    ];
    
    // 销毁旧图表
    if (browsersChart) {
        browsersChart.destroy();
    }
    
    // 创建新图表
    browsersChart = new Chart(ctx2d, {
        type: 'doughnut',
        data: {
            labels: browserLabels,
            datasets: [{
                data: browserData,
                backgroundColor: backgroundColors.slice(0, browserLabels.length),
                borderWidth: 2,
                borderColor: '#ffffff',
                hoverOffset: 10
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        padding: 20,
                        usePointStyle: true
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.raw || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = Math.round((value / total) * 100);
                            return `${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

// 更新热门页面
function updatePopularPages(popularPaths) {
    const container = document.getElementById('popularPages');
    if (!container) return;
    
    // 如果有API返回的数据，可以在这里动态更新
    // 暂时留空，因为我们已经通过模板渲染了初始数据
}

// 更新统计数字
function updateStatsNumbers(data) {
    // 这里可以从API获取最新数据更新页面上的数字
    // 暂时留空，因为我们已经通过模板渲染了初始数据
}

// 导出数据
function exportStats() {
    // 创建导出数据
    const exportData = {
        timestamp: new Date().toISOString(),
        totalVisits: document.getElementById('totalVisits').textContent,
        todayVisits: document.getElementById('todayVisits').textContent,
        weekVisits: document.getElementById('weekVisits').textContent,
        monthVisits: document.getElementById('monthVisits').textContent,
        totalPosts: document.getElementById('totalPosts').textContent,
        publishedPosts: document.getElementById('publishedPosts').textContent,
        draftPosts: document.getElementById('draftPosts').textContent,
        archivedPosts: document.getElementById('archivedPosts').textContent
    };
    
    // 创建下载链接
    const dataStr = JSON.stringify(exportData, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    const url = URL.createObjectURL(dataBlob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = `blog-stats-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showNotification('数据已导出为JSON文件', 'success');
}

// 显示通知
function showNotification(message, type = 'info', duration = 3000) {
    // 移除现有通知
    const existingAlert = document.querySelector('.stat-notification');
    if (existingAlert) {
        existingAlert.remove();
    }
    
    // 创建新通知
    const alert = document.createElement('div');
    alert.className = `stat-notification alert alert-${type} alert-dismissible fade show`;
    alert.style.cssText = `
        position: fixed;
        top: 80px;
        right: 20px;
        z-index: 9999;
        min-width: 300px;
        max-width: 400px;
        animation: slideInRight 0.3s ease;
    `;
    
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alert);
    
    // 自动隐藏
    if (duration > 0) {
        setTimeout(() => {
            if (alert.parentNode) {
                alert.remove();
            }
        }, duration);
    }
    
    // 添加动画样式
    if (!document.querySelector('#stat-notification-style')) {
        const style = document.createElement('style');
        style.id = 'stat-notification-style';
        style.textContent = `
            @keyframes slideInRight {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
        `;
        document.head.appendChild(style);
    }
}
</script>
{% endblock %}